"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const debug = require("debug");
const rxjs_1 = require("rxjs");
const dgram_1 = require("dgram");
const timing = require("./packets/timing");
const d = debug('pro-dj-link:bpm');
const _bpm = new rxjs_1.BehaviorSubject(0);
exports.track = () => {
    d('Starting BPM Tracking');
    const socket = dgram_1.createSocket({
        type: 'udp4',
        reuseAddr: true
    });
    socket.bind({
        port: 50001
    }, () => {
        socket.setBroadcast(true);
        socket.setMulticastTTL(128);
    });
    socket.on('message', (data) => {
        if (timing.test(data)) { // Timing Packet
            const { device, name, speed } = timing.parse(data);
            d(`Player ${device} (${name}): ${Math.round(speed.current)} BPM`);
            d(speed.current);
            _bpm.next(speed.current);
        }
        else {
            d('50001', data.length, data);
        }
    });
};
exports.bpm = _bpm.asObservable();
//# sourceMappingURL=tempo.js.map